!function(t,e,n){var o=function(t){this.options=Object.assign({},o.DefaultSettings,t),this.init()};o.DefaultSettings={isEraser:!1,size:5,brushSize:5,grainUrlObj:'document.getElementById("pen1")',snap:[],redoSnap:[],lineMax:40,lineMin:5,linePressure:2,smoothness:90,callback:function(){}},o.prototype.init=function(){this.undo=e.querySelector(".btn-groups .wx-btn-undo"),this.redo=e.querySelector(".btn-groups .wx-btn-redo"),this.clear=e.querySelector(".btn-groups .wx-btn-clear"),this.canvas=e.getElementById("cvs"),this.eraser=e.querySelector(".tool-eraser"),this.canvas.width=t.innerWidth||e.documentElement.clientWidth;var n=t.innerHeight||e.documentElement.innerHeight;this.canvas.height=.5082*n,this.context=this.canvas.getContext("2d"),this.context&&(this.upof={},this.radius=0,this.has=[],this.pointArr=[],this.l=5,this.initEvent())},o.prototype.setEraserStatus=function(t){this.options.isEraser=t},o.prototype.setSize=function(t){this.options.isEraser?this.options.size=Math.ceil(t/2):this.l=this.options.brushSize=Math.ceil(t/2)},o.prototype.setGrain=function(t){this.options.grainUrlObj=t},o.prototype.copyImage=function(t){var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);t.push(e),t==this.options.snap&&t.length>0&&(this.undo.className="wx-btn-undo active"),t==this.options.redoSnap&&t.length>0&&(this.redo.className="wx-btn-redo active"),t.length&&(this.clear.className="wx-btn-clear active")},o.prototype.resetEraser=function(t,e,n){this.context.globalCompositeOperation="destination-out",this.context.beginPath(),this.context.arc(t,e,this.options.size,0,2*Math.PI),this.context.strokeStyle="rgba(250,250,250,0)",this.context.fill(),this.context.globalCompositeOperation="source-over"},o.prototype.clearup=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.options.isEraser=!1,this.options.snap=[],this.options.redoSnap=[],this.undo.className="wx-btn-undo",this.redo.className="wx-btn-redo",this.clear.className="wx-btn-clear"},o.prototype.initEvent=function(){var t=this;this.canvas.addEventListener("touchstart",t.start=function(e){e.preventDefault();var n=e.targetTouches[0],o=n.clientX-t.getPosition(t.canvas).left,i=n.clientY-t.getPosition(t.canvas).top;t.has=[],t.upof={x:o,y:i},t.pointArr.unshift({x1:o,y1:i}),t.options.isEraser?t.copyImage(t.options.snap):t.copyImage(t.options.snap),t.canvas.addEventListener("touchmove",t.touchMove=function(e){e.preventDefault();var n=e.targetTouches[0],o=n.clientX-t.getPosition(t.canvas).left,i=n.clientY-t.getPosition(t.canvas).top;if(t.options.isEraser)t.resetEraser(o,i,n);else{var s={x:o,y:i},r=t.upof;t.radius;t.has.unshift({time:(new Date).getTime(),dis:t.distance(r,s)});for(var a=0,c=0,p=0;p<t.has.length-1&&(a+=t.has[p].dis,c+=t.has[p].time-t.has[p+1].time,!(a>t.options.smoothness));p++);var h=Math.min(c/a*t.options.linePressure+t.options.brushSize,t.options.lineMax)/2;t.radius=h,t.upof=s;for(var l=Math.round(t.has[0].dis/2)+1,u=0;u<l;u++){var d=r.x+(s.x-r.x)/l*u,f=r.y+(s.y-r.y)/l*u;d-=t.l/2,f-=t.l/2,t.pointArr.unshift({x:d,y:f}),t.context.beginPath(),t.context.drawImage(t.options.grainUrlObj,d,f,t.l,t.l),t.l=t.l-.2,t.l<t.options.brushSize/2&&(t.l=Math.ceil(t.options.brushSize/2))}}},!1)},!1),this.canvas.addEventListener("touchend",function(e){if(t.l=t.options.brushSize,!t.options.isEraser&&t.pointArr.length>60){for(var n=0;n<40;n++)t.pointArr[n].x=t.pointArr[n].x-t.l/4,t.pointArr[n].y=t.pointArr[n].y-t.l/4,t.context.drawImage(t.options.grainUrlObj,t.pointArr[n].x+2,t.pointArr[n].y+2,t.l,t.l),t.l=t.l-.25,t.l<t.options.brushSize/2&&(t.l=Math.ceil(t.options.brushSize/2));t.l=t.options.brushSize,t.pointArr=[]}t.options.isEraser||1!=t.pointArr.length||t.context.drawImage(t.options.grainUrlObj,t.pointArr[0].x1-t.l/2,t.pointArr[0].y1-t.l/2,t.l,t.l),t.pointArr=[],t.canvas.removeEventListener("touchmove",t.touchMove,!1)},!1),this.clear.onclick=function(){t.preventDisabedBtn(this)&&(n(".edit-tool ").removeClass("active fadeInUp"),e.querySelector(".dialog-confirm").style.display="block")},this.undo.onclick=function(){if(t.preventDisabedBtn(this)){t.copyImage(t.options.redoSnap);var e=t.options.snap.pop();t.context.putImageData(e,0,0),t.options.snap.length<=0&&(t.undo.className="wx-btn-undo")}},this.redo.onclick=function(){if(t.preventDisabedBtn(this)){t.copyImage(t.options.snap);var e=t.options.redoSnap.pop();t.options.redoSnap.length<=0&&(t.redo.className="wx-btn-redo"),t.context.putImageData(e,0,0)}}},o.prototype.preventDisabedBtn=function(t){return!(t.className.indexOf("active")<0)},o.prototype.getPosition=function(t){var e=t.offsetLeft,n=t.offsetTop;for(current=t.offsetParent;null!=current;)e+=current.offsetLeft,n+=current.offsetTop,current=current.offsetParent;return{left:e,top:n}},o.prototype.distance=function(t,e){var n=e.x-t.x,o=e.y-t.y;return Math.sqrt(n*n+o*o)},t.Editor=o}(window,document,$);